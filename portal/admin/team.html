<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Portal ‚Äî Content Bug</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-base: #050508;
            --bg-elevated: #0a0a0f;
            --bg-surface: #0f0f14;
            --bg-card: #101015;
            --bg-hover: #16161c;
            --bg-active: #1c1c24;

            --border-subtle: rgba(59, 130, 246, 0.08);
            --border-default: rgba(59, 130, 246, 0.12);
            --border-strong: rgba(59, 130, 246, 0.2);

            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            --accent-blue: #3b82f6;
            --accent-blue-soft: rgba(59,130,246,0.12);
            --accent-green: #22c55e;
            --accent-green-soft: rgba(34,197,94,0.12);
            --accent-orange: #f59e0b;
            --accent-orange-soft: rgba(245,158,11,0.15);
            --accent-red: #ef4444;
            --accent-red-soft: rgba(239,68,68,0.15);
            --accent-purple: #a855f7;
            --accent-purple-soft: rgba(168,85,247,0.12);

            /* Plan Colors */
            --plan-basic: #3b82f6;
            --plan-silver: #94a3b8;
            --plan-gold: #f59e0b;
            --plan-growth: #10b981;
            --plan-creator: #f59e0b;
            --plan-pro: #a855f7;
            --plan-trial: #22c55e;

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;

            --header-height: 56px;
        }

        html, body {
            height: 100%;
            background: var(--bg-base);
            font-family: 'Inter', -apple-system, sans-serif;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* App Container */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-logo {
            height: 32px;
        }

        .header-nav {
            display: flex;
            gap: 4px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-btn.active { background: var(--accent-blue-soft); color: var(--accent-blue); }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge-counter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--accent-red);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            cursor: pointer;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-blue-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active { display: flex; }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 16px;
            padding: 16px 24px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            min-width: 140px;
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.blue { background: var(--accent-blue-soft); }
        .stat-icon.green { background: var(--accent-green-soft); }
        .stat-icon.orange { background: var(--accent-orange-soft); }
        .stat-icon.red { background: var(--accent-red-soft); }

        .stat-info { display: flex; flex-direction: column; }
        .stat-value { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .stat-label { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Kanban Board */
        .kanban-container {
            flex: 1;
            display: flex;
            overflow-x: auto;
            padding: 20px;
            gap: 16px;
        }

        .kanban-column {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            max-height: 100%;
        }

        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .column-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 22px;
            height: 22px;
            padding: 0 6px;
            background: var(--bg-surface);
            border-radius: 11px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .column-cards {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Project Card */
        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-card:hover {
            border-color: var(--border-strong);
            transform: translateY(-1px);
        }

        .project-card.dragging {
            opacity: 0.5;
            border-color: var(--accent-blue);
        }

        .project-card.late {
            border-left: 3px solid var(--accent-red);
        }

        .project-card.at-risk {
            border-left: 3px solid var(--accent-orange);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .card-type-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .card-type-badge.short { background: var(--accent-blue-soft); color: var(--accent-blue); }
        .card-type-badge.long { background: var(--accent-purple-soft); color: var(--accent-purple); }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .meta-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--bg-surface);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .meta-chip.tier-1 { background: var(--accent-green-soft); color: var(--accent-green); }
        .meta-chip.tier-2 { background: var(--accent-orange-soft); color: var(--accent-orange); }
        .meta-chip.tier-3 { background: var(--accent-red-soft); color: var(--accent-red); }

        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        .card-dates {
            font-size: 11px;
            color: var(--text-muted);
        }

        .card-late-badge {
            padding: 2px 6px;
            background: var(--accent-red-soft);
            color: var(--accent-red);
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
        }

        .revision-badge {
            padding: 2px 6px;
            background: var(--accent-orange-soft);
            color: var(--accent-orange);
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
        }

        .revision-badge.critical {
            background: var(--accent-red-soft);
            color: var(--accent-red);
        }

        /* Client Card (for assignment board) */
        .client-card {
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 14px;
            cursor: grab;
            transition: all 0.2s;
        }

        .client-card:hover {
            border-color: var(--border-strong);
        }

        .client-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        /* Plan border colors */
        .client-card.plan-basic { border-color: var(--plan-basic); }
        .client-card.plan-silver { border-color: var(--plan-silver); }
        .client-card.plan-gold { border-color: var(--plan-gold); }
        .client-card.plan-growth { border-color: var(--plan-growth); }
        .client-card.plan-creator { border-color: var(--plan-creator); }
        .client-card.plan-pro { border-color: var(--plan-pro); }
        .client-card.plan-trial { border-color: var(--plan-trial); }

        .client-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .client-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-blue-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .client-info { flex: 1; }
        .client-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .client-email { font-size: 11px; color: var(--text-muted); }

        .plan-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .plan-badge.basic { background: rgba(59,130,246,0.15); color: var(--plan-basic); }
        .plan-badge.silver { background: rgba(148,163,184,0.15); color: var(--plan-silver); }
        .plan-badge.gold { background: rgba(245,158,11,0.15); color: var(--plan-gold); }
        .plan-badge.growth { background: rgba(16,185,129,0.15); color: var(--plan-growth); }
        .plan-badge.creator { background: rgba(245,158,11,0.15); color: var(--plan-creator); }
        .plan-badge.pro { background: rgba(168,85,247,0.15); color: var(--plan-pro); }
        .plan-badge.trial { background: rgba(34,197,94,0.15); color: var(--plan-trial); }

        .client-stats {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .client-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Editor Column Header */
        .editor-column-header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-surface);
        }

        .editor-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .editor-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-blue-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .editor-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }

        .editor-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .metric {
            display: flex;
            flex-direction: column;
            padding: 6px 8px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
        }

        .metric-value { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .metric-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }

        .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .health-indicator.healthy { background: var(--accent-green); }
        .health-indicator.watch { background: var(--accent-orange); }
        .health-indicator.risk { background: var(--accent-red); }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Purge Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .modal-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--bg-surface);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* QA Panel (Owner only) */
        .qa-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            padding: 16px;
            z-index: 100;
            display: none;
        }

        .qa-panel.visible { display: block; }

        .qa-panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .qa-btn {
            display: block;
            width: 100%;
            padding: 10px 16px;
            margin-bottom: 8px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .qa-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .qa-btn.danger {
            color: var(--accent-red);
        }

        .qa-btn.danger:hover {
            background: var(--accent-red-soft);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <img src="https://storage.googleapis.com/msgsndr/mCNHhjy593eUueqfuqyU/media/6930abb0e0f092608f6ec5e6.png" alt="ContentBug" class="brand-logo">
                <nav class="header-nav">
                    <button class="nav-btn active" data-tab="my-work">My Work</button>
                    <button class="nav-btn" data-tab="my-clients">My Clients</button>
                    <button class="nav-btn" data-tab="assignment" id="assignmentTab">Assignment Board <span class="badge-counter" id="unassignedBadge" style="display:none">0</span></button>
                    <button class="nav-btn" data-tab="all-projects" id="allProjectsTab">All Projects</button>
                </nav>
            </div>
            <div class="header-right">
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <span id="userName">Loading...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- My Work Tab (Editor Kanban) -->
            <div class="tab-content active" id="tab-my-work">
                <div class="stats-bar" id="myWorkStats">
                    <div class="stat-card">
                        <div class="stat-icon blue">üìã</div>
                        <div class="stat-info">
                            <span class="stat-value" id="statQueued">0</span>
                            <span class="stat-label">Queued</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">‚ö°</div>
                        <div class="stat-info">
                            <span class="stat-value" id="statInProgress">0</span>
                            <span class="stat-label">In Progress</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">üëÅÔ∏è</div>
                        <div class="stat-info">
                            <span class="stat-value" id="statReview">0</span>
                            <span class="stat-label">In Review</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">‚ö†Ô∏è</div>
                        <div class="stat-info">
                            <span class="stat-value" id="statLate">0</span>
                            <span class="stat-label">Late</span>
                        </div>
                    </div>
                </div>
                <div class="kanban-container" id="myWorkKanban">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- My Clients Tab -->
            <div class="tab-content" id="tab-my-clients">
                <div class="kanban-container" id="myClientsContainer">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Assignment Board Tab (Admin/Owner) -->
            <div class="tab-content" id="tab-assignment">
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-icon orange">üÜï</div>
                        <div class="stat-info">
                            <span class="stat-value" id="statUnassigned">0</span>
                            <span class="stat-label">Unassigned</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">üë•</div>
                        <div class="stat-info">
                            <span class="stat-value" id="statEditors">0</span>
                            <span class="stat-label">Editors</span>
                        </div>
                    </div>
                </div>
                <div class="kanban-container" id="assignmentKanban">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- All Projects Tab (Admin/Owner) -->
            <div class="tab-content" id="tab-all-projects">
                <div class="stats-bar" id="allProjectsStats"></div>
                <div class="kanban-container" id="allProjectsKanban">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Purge Modal -->
    <div class="modal-overlay" id="purgeModal">
        <div class="modal">
            <h3 class="modal-title">‚ö†Ô∏è Purge Sample Data</h3>
            <p class="modal-text">
                This will permanently delete ALL records marked as sample data from the database. This action cannot be undone.
                <br><br>
                Type <strong>PURGE SAMPLE DATA</strong> to confirm.
            </p>
            <input type="text" class="modal-input" id="purgeConfirmInput" placeholder="Type confirmation here">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePurgeModal()">Cancel</button>
                <button class="btn btn-danger" id="purgeConfirmBtn" disabled onclick="executePurge()">Purge Data</button>
            </div>
        </div>
    </div>

    <!-- QA Panel (Owner only) -->
    <div class="qa-panel" id="qaPanel">
        <div class="qa-panel-title">üîß QA Tools</div>
        <button class="qa-btn" onclick="previewPurge()">Preview Sample Data</button>
        <button class="qa-btn danger" onclick="openPurgeModal()">Reset Demo Data</button>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================================
        // INITIALIZATION
        // ============================================

        let currentUser = null;
        let currentTab = 'my-work';

        async function init() {
            try {
                // Get current user session
                const res = await fetch('/api/me');
                if (!res.ok) {
                    window.location.href = '/login';
                    return;
                }

                currentUser = await res.json();

                // Update UI
                document.getElementById('userName').textContent = currentUser.name || currentUser.email.split('@')[0];
                document.getElementById('userAvatar').textContent = (currentUser.name || currentUser.email)[0].toUpperCase();

                // Show/hide tabs based on role
                if (!['admin', 'owner'].includes(currentUser.role)) {
                    document.getElementById('assignmentTab').style.display = 'none';
                    document.getElementById('allProjectsTab').style.display = 'none';
                }

                // Show QA panel for owners
                if (currentUser.role === 'owner') {
                    document.getElementById('qaPanel').classList.add('visible');
                }

                // Load initial data
                await loadMyWork();
                await loadStats();

            } catch (err) {
                console.error('Init error:', err);
                showToast('Failed to initialize', 'error');
            }
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const tab = btn.dataset.tab;
                if (tab === currentTab) return;

                // Update active states
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');

                currentTab = tab;

                // Load tab data
                switch (tab) {
                    case 'my-work':
                        await loadMyWork();
                        break;
                    case 'my-clients':
                        await loadMyClients();
                        break;
                    case 'assignment':
                        await loadAssignmentBoard();
                        break;
                    case 'all-projects':
                        await loadAllProjects();
                        break;
                }
            });
        });

        // ============================================
        // DATA LOADING
        // ============================================

        async function loadMyWork() {
            const container = document.getElementById('myWorkKanban');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const res = await fetch('/api/kanban/projects');
                const data = await res.json();

                if (data.error) throw new Error(data.message);

                renderKanban(container, data.columns, true);
                updateMyWorkStats(data.columns);

            } catch (err) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">Error loading projects</div><div class="empty-state-text">${err.message}</div></div>`;
            }
        }

        async function loadStats() {
            if (!['admin', 'owner'].includes(currentUser?.role)) return;

            try {
                const res = await fetch('/api/team/stats');
                const data = await res.json();

                // Update unassigned badge
                if (data.unassignedClientsCount > 0) {
                    document.getElementById('unassignedBadge').textContent = data.unassignedClientsCount;
                    document.getElementById('unassignedBadge').style.display = 'inline-flex';
                }

                document.getElementById('statUnassigned').textContent = data.unassignedClientsCount;
                document.getElementById('statEditors').textContent = data.activeEditorsCount;

            } catch (err) {
                console.error('Stats error:', err);
            }
        }

        async function loadMyClients() {
            const container = document.getElementById('myClientsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const res = await fetch(`/api/team/editor/${currentUser.userRecordId}/clients`);
                const data = await res.json();

                if (data.error) throw new Error(data.message);

                if (!data.clients?.length) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><div class="empty-state-title">No clients assigned</div><div class="empty-state-text">Clients will appear here when assigned to you</div></div>';
                    return;
                }

                container.innerHTML = data.clients.map(c => renderClientCard(c)).join('');

            } catch (err) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">Error</div><div class="empty-state-text">${err.message}</div></div>`;
            }
        }

        async function loadAssignmentBoard() {
            const container = document.getElementById('assignmentKanban');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                // Load unassigned clients and editors in parallel
                const [unassignedRes, editorsRes] = await Promise.all([
                    fetch('/api/team/unassigned-clients'),
                    fetch('/api/team/members?activeOnly=true')
                ]);

                const unassigned = await unassignedRes.json();
                const editors = await editorsRes.json();

                const editorList = (editors.members || []).filter(m => m.role === 'editor');

                // Build columns
                let html = '';

                // Unassigned column
                html += `
                    <div class="kanban-column" data-editor-id="unassigned">
                        <div class="column-header">
                            <div class="column-title">üÜï NEW (Unassigned)</div>
                            <span class="column-count">${unassigned.clients?.length || 0}</span>
                        </div>
                        <div class="column-cards" ondrop="dropClient(event, 'unassigned')" ondragover="event.preventDefault()">
                            ${(unassigned.clients || []).map(c => renderClientCard(c, true)).join('') || '<div class="empty-state"><div class="empty-state-text">No unassigned clients</div></div>'}
                        </div>
                    </div>
                `;

                // Editor columns
                for (const editor of editorList) {
                    const clientsRes = await fetch(`/api/team/editor/${editor.id}/clients`);
                    const clientsData = await clientsRes.json();
                    const clients = clientsData.clients || [];

                    // Calculate health
                    const health = editor.lateProjectCount > 2 ? 'risk' : editor.lateProjectCount > 0 ? 'watch' : 'healthy';

                    html += `
                        <div class="kanban-column" data-editor-id="${editor.id}">
                            <div class="editor-column-header">
                                <div class="editor-info">
                                    <div class="editor-avatar">${(editor.name || 'E')[0]}</div>
                                    <span class="editor-name">${editor.name}</span>
                                    <div class="health-indicator ${health}"></div>
                                </div>
                                <div class="editor-metrics">
                                    <div class="metric">
                                        <span class="metric-value">${(editor.avgQualityScore || 0).toFixed(1)}</span>
                                        <span class="metric-label">Quality</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-value">${(editor.avgTurnaroundScore || 0).toFixed(1)}</span>
                                        <span class="metric-label">Speed</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-value">${clients.length}</span>
                                        <span class="metric-label">Clients</span>
                                    </div>
                                </div>
                            </div>
                            <div class="column-cards" ondrop="dropClient(event, '${editor.id}')" ondragover="event.preventDefault()">
                                ${clients.map(c => renderClientCard(c, true)).join('') || '<div class="empty-state"><div class="empty-state-text">Drop clients here</div></div>'}
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (err) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">Error</div><div class="empty-state-text">${err.message}</div></div>`;
            }
        }

        async function loadAllProjects() {
            const container = document.getElementById('allProjectsKanban');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const res = await fetch('/api/kanban/projects');
                const data = await res.json();

                if (data.error) throw new Error(data.message);

                renderKanban(container, data.columns, false);

            } catch (err) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">Error</div><div class="empty-state-text">${err.message}</div></div>`;
            }
        }

        // ============================================
        // RENDERING
        // ============================================

        function renderKanban(container, columns, draggable = false) {
            const columnOrder = ['queued', 'in_edit', 'review_ready', 'revisions', 'approved'];

            let html = '';
            for (const status of columnOrder) {
                const col = columns[status];
                if (!col) continue;

                html += `
                    <div class="kanban-column" data-status="${status}">
                        <div class="column-header">
                            <div class="column-title">${col.label}</div>
                            <span class="column-count">${col.projects.length}</span>
                        </div>
                        <div class="column-cards" ${draggable ? `ondrop="dropProject(event, '${status}')" ondragover="event.preventDefault()"` : ''}>
                            ${col.projects.map(p => renderProjectCard(p, draggable)).join('') || '<div class="empty-state"><div class="empty-state-text">No projects</div></div>'}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderProjectCard(project, draggable = false) {
            const typeClass = project.projectType?.toLowerCase().includes('long') ? 'long' : 'short';
            const tierClass = project.tier?.replace('_', '-') || 'tier-2';
            const lateClass = project.isLate ? 'late' : (project.daysLate === 0 && project.editorDueDate ? 'at-risk' : '');

            return `
                <div class="project-card ${lateClass}"
                     data-id="${project.id}"
                     ${draggable ? 'draggable="true" ondragstart="dragProject(event)"' : ''}
                     onclick="openProject('${project.id}', '${project.status}')">
                    <div class="card-header">
                        <span class="card-title">${escapeHtml(project.title)}</span>
                        <span class="card-type-badge ${typeClass}">${project.projectType || 'Short'}</span>
                    </div>
                    <div class="card-meta">
                        ${project.blueprintName ? `<span class="meta-chip">üìã ${escapeHtml(project.blueprintName)}</span>` : ''}
                        <span class="meta-chip ${tierClass}">${project.tier?.replace('_', ' ').toUpperCase() || 'TIER 2'}</span>
                        <span class="meta-chip">${project.assignedEditor || 'Unassigned'}</span>
                    </div>
                    <div class="card-footer">
                        <span class="card-dates">
                            ${project.dateSubmitted ? `üìÖ ${project.dateSubmitted}` : ''}
                            ${project.eta ? ` ‚Üí ${project.eta}` : ''}
                        </span>
                        ${project.isLate ? `<span class="card-late-badge">LATE ${project.daysLate}d</span>` : ''}
                        ${project.revisionCount > 3 ? `<span class="revision-badge ${project.revisionFlag}">üîÑ ${project.revisionCount}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function renderClientCard(client, draggable = false) {
            const planClass = (client.plan || 'trial').toLowerCase().replace(/\s+/g, '-').replace('free-', '');

            return `
                <div class="client-card plan-${planClass}"
                     data-id="${client.id}"
                     ${draggable ? 'draggable="true" ondragstart="dragClient(event)"' : ''}>
                    <div class="client-header">
                        <div class="client-avatar">${(client.name || 'C')[0].toUpperCase()}</div>
                        <div class="client-info">
                            <div class="client-name">${escapeHtml(client.name || 'Unknown')}</div>
                            ${currentUser?.role !== 'editor' ? `<div class="client-email">${client.email || ''}</div>` : ''}
                        </div>
                        <span class="plan-badge ${planClass}">${client.plan || 'Trial'}</span>
                    </div>
                    <div class="client-stats">
                        <span>üìä ${client.projectsSubmitted || 0} projects</span>
                        ${client.lastActiveAt ? `<span>üïê ${formatRelativeTime(client.lastActiveAt)}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function updateMyWorkStats(columns) {
            document.getElementById('statQueued').textContent = columns.queued?.projects?.length || 0;
            document.getElementById('statInProgress').textContent = columns.in_edit?.projects?.length || 0;
            document.getElementById('statReview').textContent = columns.review_ready?.projects?.length || 0;

            // Count late projects
            let lateCount = 0;
            for (const col of Object.values(columns)) {
                lateCount += (col.projects || []).filter(p => p.isLate).length;
            }
            document.getElementById('statLate').textContent = lateCount;
        }

        // ============================================
        // DRAG & DROP
        // ============================================

        let draggedProjectId = null;
        let draggedClientId = null;

        function dragProject(event) {
            draggedProjectId = event.target.dataset.id;
            event.target.classList.add('dragging');
        }

        function dropProject(event, newStatus) {
            event.preventDefault();
            if (!draggedProjectId) return;

            // Find and remove dragging class
            document.querySelectorAll('.project-card.dragging').forEach(c => c.classList.remove('dragging'));

            updateProjectStatus(draggedProjectId, newStatus);
            draggedProjectId = null;
        }

        function dragClient(event) {
            draggedClientId = event.target.dataset.id;
            event.target.classList.add('dragging');
        }

        function dropClient(event, editorId) {
            event.preventDefault();
            if (!draggedClientId) return;

            document.querySelectorAll('.client-card.dragging').forEach(c => c.classList.remove('dragging'));

            if (editorId === 'unassigned') {
                // Can't unassign via drag for now
                showToast('Cannot unassign via drag', 'error');
            } else {
                assignClient(draggedClientId, editorId);
            }
            draggedClientId = null;
        }

        async function updateProjectStatus(projectId, newStatus) {
            try {
                const res = await fetch(`/api/kanban/project/${projectId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newStatus })
                });

                const data = await res.json();

                if (!res.ok) {
                    showToast(data.message || 'Failed to update status', 'error');
                    return;
                }

                showToast(data.message, 'success');

                // Reload current view
                if (currentTab === 'my-work') await loadMyWork();
                else if (currentTab === 'all-projects') await loadAllProjects();

            } catch (err) {
                showToast('Error updating project', 'error');
            }
        }

        async function assignClient(clientId, editorId) {
            try {
                const res = await fetch('/api/team/assign-client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId, editorId })
                });

                const data = await res.json();

                if (!res.ok) {
                    showToast(data.message || 'Failed to assign client', 'error');
                    return;
                }

                showToast('Client assigned successfully', 'success');
                await loadAssignmentBoard();
                await loadStats();

            } catch (err) {
                showToast('Error assigning client', 'error');
            }
        }

        // ============================================
        // PROJECT ACTIONS
        // ============================================

        function openProject(projectId, status) {
            if (['review_ready', 'revisions', 'approved'].includes(status)) {
                window.location.href = `/review?id=${projectId}`;
            } else {
                // Show project details modal or go to projects page
                window.location.href = `/projects?id=${projectId}`;
            }
        }

        // ============================================
        // PURGE SAMPLE DATA
        // ============================================

        function openPurgeModal() {
            document.getElementById('purgeModal').classList.add('active');
            document.getElementById('purgeConfirmInput').value = '';
            document.getElementById('purgeConfirmBtn').disabled = true;
        }

        function closePurgeModal() {
            document.getElementById('purgeModal').classList.remove('active');
        }

        document.getElementById('purgeConfirmInput').addEventListener('input', (e) => {
            document.getElementById('purgeConfirmBtn').disabled = e.target.value !== 'PURGE SAMPLE DATA';
        });

        async function previewPurge() {
            try {
                const res = await fetch('/admin/sample-data-count');
                const data = await res.json();

                let message = `Sample data counts:\n`;
                for (const item of data.counts) {
                    if (item.count > 0) {
                        message += `‚Ä¢ ${item.table}: ${item.count}\n`;
                    }
                }
                message += `\nTotal: ${data.total} records`;

                alert(message);
            } catch (err) {
                showToast('Error loading counts', 'error');
            }
        }

        async function executePurge() {
            try {
                const res = await fetch('/admin/purge-sample-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirmation: 'PURGE SAMPLE DATA' })
                });

                const data = await res.json();

                closePurgeModal();

                if (!res.ok) {
                    showToast(data.message || 'Purge failed', 'error');
                    return;
                }

                showToast(`Purged ${data.totalDeleted} sample records`, 'success');

                // Reload data
                await loadMyWork();
                await loadStats();

            } catch (err) {
                showToast('Error during purge', 'error');
            }
        }

        // ============================================
        // UTILITIES
        // ============================================

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function formatRelativeTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.remove(), 4000);
        }

        // Initialize
        init();
    </script>
</body>
</html>
